# Newspaper Redirector

Production-ready PHP 8.2+ application that delivers permanent QR-code friendly endpoints for Core Life newspapers. Each endpoint always redirects to the latest issue based on date, sequence number, or monthly cadence.

## Features

- Lightweight custom MVC running on PHP-FPM (no framework).
- Public directory-based endpoints (`/okaz/`, `/arabnews/`, etc.) with Tailwind-powered listing page.
- Secure admin panel with CSRF protection, rate-limited login, and manual sequence adjustments.
- Daily cron-safe sequence incrementer with HEAD rollback checks.
- Health endpoint (`/admin/status.json`) for operational visibility.
- Docker Compose stack (PHP-FPM, Nginx, MySQL) plus CI for PHPCS, Psalm, and PHPUnit.

## Getting Started

### Prerequisites

- PHP 8.2+
- Composer
- MySQL 8+
- Node is **not** required.

### Environment

Copy the example environment file and adjust secrets:

```bash
cp .env.example .env
```

Set `ADMIN_PASSWORD_HASH` to a hash generated by:

```bash
php -r "echo password_hash('your-password', PASSWORD_BCRYPT), PHP_EOL;"
```

### Local Development with Docker

```bash
make up
# first boot only
docker-compose exec app composer install
```

Run database migrations and seed data:

```bash
docker-compose exec app php scripts/migrate.php
docker-compose exec app php scripts/seed.php
```

Visit `http://localhost:8080/` for the public list and `http://localhost:8080/admin/login` for admin.

Shut down the stack:

```bash
make down
```

### Bare-Metal Setup

1. Install PHP 8.2, Nginx or Apache, and MySQL 8+.
2. Clone the repository and run `composer install`.
3. Configure environment variables (`.env`).
4. Run migrations and seeders:
   ```bash
   php scripts/migrate.php
   php scripts/seed.php
   ```
5. Configure web server to serve the `public/` directory (samples below).
6. Ensure `storage/` is writable by the web server user.

### Database Schema

Run `php scripts/migrate.php` to create the `newspapers` table. Seed defaults with `php scripts/seed.php`.

Seeded rows include:

- `arabnews` – sequence-based (`https://www.arabnews.com/sites/default/files/pdf/{id}/index.html`)
- `aawsat` – sequence-based (`https://aawsat.com/files/pdf/issue{id}/`)
- `okaz` – date-based
- `ring` – monthly magazine

Sequence-based newspapers can optionally specify a `pattern` containing `{id}` to override the default `/{id}/index.html` suffix (used for Aawsat's `issue{id}/` format).

### Daily Cron

Schedule the incrementer in KSA local time:

```
5 0 * * * /usr/bin/php /var/www/newspaper-redirector/scripts/cron_increment.php >> /var/www/newspaper-redirector/storage/logs/cron.log 2>&1
```

The script is idempotent, heals missed days, and rolls back on HEAD 404s.

### Makefile Helpers

- `make install` – Composer install.
- `make cs` – Run PHPCS (PSR-12).
- `make stan` – Run Psalm static analysis.
- `make test` – PHPUnit test suite.
- `make seed` – Seed base newspapers.
- `make up` / `make down` – Docker lifecycle.

### Continuous Integration

GitHub Actions workflow runs PHPCS, Psalm, and PHPUnit on each push/PR.

### Web Server Configuration

#### Nginx

```
server {
    listen 80;
    server_name example.com;
    root /var/www/newspaper-redirector/public;

    index index.php;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        include fastcgi_params;
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }
}
```

#### Apache (.htaccess included)

```
Options -Indexes
RewriteEngine On
RewriteBase /
RewriteRule ^admin/status\.json$ index.php [L,QSA]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^ index.php [L]
```

### Troubleshooting

- Ensure `storage/logs` and `storage/cache` are writable.
- Confirm MySQL credentials match `.env`.
- For login lockouts, remove `storage/cache/login_attempts.json`.
- Review `storage/logs/app.log` and `storage/logs/cron.log` for errors.

## Admin Panel

Default credentials from `.env.example`:

- Username: `admin`
- Password hash placeholder – replace with your hash.

Admin features:

- View newspaper metadata, last redirect, and provider IDs.
- Increment/decrement or set exact sequence IDs (sequence types only).
- Logout, CSRF-protected actions, and rate-limited login.

## Observability

- `/admin/status.json` exposes operational metrics (count, pending sequences, last redirect info).
- Logs written to `storage/logs/app.log` and `storage/logs/cron.log`.

## Optional Probing

`scripts/probe_head.php` issues HEAD requests against all configured destinations and prints the computed URLs for verification.
